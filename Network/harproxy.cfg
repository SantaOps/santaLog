# --------------------
# 기존에 있는 내용
# --------------------
global
    log /dev/log    local0
    log /dev/log    local1 notice
    chroot /var/lib/haproxy
    stats socket /run/haproxy/admin.sock mode 660 level admin expose-fd listeners
    stats timeout 30s
    user haproxy
    group haproxy
    daemon

defaults
    log     global
    mode    http
    option  httplog
    option  dontlognull
    timeout connect 5000
    timeout client  50000
    timeout server  50000
    errorfile 400 /etc/haproxy/errors/400.http
    errorfile 403 /etc/haproxy/errors/403.http
    errorfile 408 /etc/haproxy/errors/408.http
    errorfile 500 /etc/haproxy/errors/500.http
    errorfile 502 /etc/haproxy/errors/502.http
    errorfile 503 /etc/haproxy/errors/503.http
    errorfile 504 /etc/haproxy/errors/504.http
    
    
# -----------------
# 아래 내용을 추가
# -----------------

# =================================================
# 1. Kubernetes API Server (관리자용 - kubectl)
# =================================================
frontend k8s_api
    bind *:6443
    mode tcp
    option tcplog
    default_backend k8s_masters

backend k8s_masters
    mode tcp
    option tcp-check
    balance roundrobin
    tcp-check connect port 6443
    timeout check 30s
   
    # 테라폼 코드 기준 Master 노드들
    server s1-Master 192.168.60.121:6443 check inter 10s rise 3 fall 2 backup weight 10
    server s3-Master 192.168.40.121:6443 check inter 10s rise 3 fall 2 weight 1
    server s4-Master 192.168.40.221:6443 check inter 10s rise 3 fall 2 weight 1
    # (참고: s2에는 Master가 없으므로 뺍니다)

# =================================================
# 2. Ingress Traffic (사용자용 - 웹사이트 HTTP/HTTPS)
# =================================================
# 웹 브라우저가 80(HTTP)이나 443(HTTPS)으로 들어오면
# 워커 노드의 "NodePort"나 "HostPort"로 넘겨줍니다.
# 여기서는 워커 노드의 30080(HTTP), 30443(HTTPS) 포트로 가정합니다.
# (K8s Ingress Controller 설정에 따라 포트는 다를 수 있습니다)

frontend http_ingress
    bind *:80
    mode tcp
    option tcplog
    default_backend k8s_workers_http

frontend https_ingress
    bind *:443
    mode tcp
    option tcplog
    default_backend k8s_workers_https

backend k8s_workers_http
    mode tcp
    balance roundrobin
    server METALLB-VIP-HTTP 192.168.60.202:80 check
    # MetalLB 사용으로 아래는 더이상 필요없음
    # 워커 노드들 (서울)    
    # server s1-Worker 192.168.60.126:30080 check
    # server s2-Worker 192.168.60.226:30080 check
    # 워커 노드들 (부산)
    #server s3-Worker 192.168.40.126:30080 check
    #server s4-Worker 192.168.40.226:30080 check

backend k8s_workers_https
    mode tcp
    balance roundrobin
    server METALLB-VIP-HTTP 192.168.60.202:443 check
    # 워커 노드들 (HTTPS용 포트)
    #server s1-Worker 192.168.60.126:30443 check
    #server s2-Worker 192.168.60.226:30443 check
    #server s3-Worker 192.168.40.126:30443 check
    #server s4-Worker 192.168.40.226:30443 check
    
# ---------------------------------------------------------------------
# 3. HAProxy Stats Page (상태 모니터링용 웹페이지)
# 접속 주소: http://192.168.50.115:8404/stats
# ---------------------------------------------------------------------
frontend stats
    bind *:8404
    mode http
    stats enable
    stats uri /stats
    stats refresh 10s
    stats admin if LOCALHOST
    
    # [추천] 보안 설정 (아이디: admin / 비번: password) -> 원하는 대로 변경하세요
    # stats auth admin:password # 귀찮다. 하지말자

    # [핵심] 모니터링 VM(Prometheus)이 긁어갈 수 있는 전용 페이지
    # (나중에 http://192.168.50.115:8404/metrics 로 긁어가면 됩니다)
    http-request use-service prometheus-exporter if { path /metrics }
